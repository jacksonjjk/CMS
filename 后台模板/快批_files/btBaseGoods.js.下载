/**
 * 存货列表
 * 
 * @author gin、dengyq
 * @date 2015-08-28
 */

/**
 * 全局变量
 */
var iscopy = true; // 是否复制新增
var curRowIndex = 0; // 当前页行记录索引
var previewDiv = ""; // 缓存图片预览 Div 的 innerHTML 内容
var tbOldCostPrice = 0; // 旧成本价，用于判断成本价为0修改利润
var tbOldQty=0;//旧库存，判断是否修改了商品的库存
var enabled2DTable = false; // 是否二维货品
var pda2DTable="";//是否开启二维功能
var imageKIDList = []; // 货品图片集
var pdaQtyScale = 0;
var pdaMoneyScale = 0; 
var clock_check;
//var max_x=0;//最大维度一
//var max_y=0;//最大维度二
var isModestock=false;//是否修改过库存
var IsDimensionOne=false;//是否存在维度1
var IsDimensionSec=false;//是否存在维度2
var isAdvancedSearch = false; // 是否为高级搜索（筛选）
var isDefaultSearch = false; // 是否为默认搜索
var advancedSearch = ""; // 高级筛选对象

var cacheDimensionOneData = ""; // 缓存企业维度一数据
var cacheDimensionSecData = ""; // 缓存企业维度二数据

var pdaStorage = "0"; // 是否开启多仓 1==开启 0==未开启
var serverStorage = "0";//服务端仓库参数
var defaultStorageKID = "";

var isOpenMultiCode ="";

var pdaMultUnit = "0"; //是否开启多价格
var padIsShowClass="1";//是否开启单位

var Money_Scale = '';//小数位的保留位数

// 页脚统计（存起来为了解决表格改变大小时页脚丢失的问题）
var footerQty = "";
var footerCostMoney = "";
//初始化参数
var checkAllCurrentRows = false;
//数据导出参数
var pageSize;
var pageNumber;
var sortName="",sortOrder="";
var myIsAdvancedSearch=false;
var searchText="";
var startDate="",endDate="";
var enterpriseKID = "";
var notUpGoods="";

var isAddGoods=false;//是否是新增
var isSaveAuto = false;//是否自动保存
var searchVal = '' ;
$(function(){	
	
	// 隐藏标签页头
	$("#myTab").hide();
	
	pdaQtyScale = $('#Qty_Scale').val();
	pdaMoneyScale = $('#Money_Scale').val();   
	previewDiv = document.getElementById('preview').innerHTML;
	pda2DTable = $('#Enable_2D_Table').val() == "1" ? true : false;
	enterpriseKID = $("#enterpriseKID").val();
	Money_Scale = $("#Money_Scale").val();
	
	//获取标签集
	getTagGoods(enterpriseKID);
//	加载缓存
	getGoodsBuffer();
	//加载企业配置信息
	//pdaStorage = $("#PDA_Storage").val();
	loadSysSetting(enterpriseKID);
	pdaStorage = $("#PDA_Storage").val();
	pdaMultUnit = $("#Enable_Multi_Unit").val();
	padIsShowClass = $("#i_PDA_Goods_Class_Show").val();
	
	serverStorage = $("#SERVER_Storage").val();
	defaultStorageKID = $("#defaultStorageKID").val();
	
	isOpenMultiCode=$("#i_IsOpen_Multi_Code").val();
	
	// 开启多仓时暂时禁用编辑功能
	/*if (pdaStorage == "1" || pdaStorage == 1) {
		// 禁用新增
		$('#btnAdd').attr("disabled", "disabled");
		
		//禁用导入
		$('#btnImport').attr("disabled", "disabled");
		
		// 禁用修改库存
		$('#li_update_stock').addClass("disabled");
		$('#li_update_stock').find("a").removeAttr("onclick");
	}*/
	// 关闭多仓时禁用仓库搜索功能
	if (pdaStorage == "0" || pdaStorage == 0){
		$('#storage').addClass("hidden");
		
	}else{
		//获取仓库 
		getStorage(enterpriseKID);
		
	}
	if(pdaMultUnit=="0" || pdaMultUnit ==0){
		$('#isUnit').addClass("hidden");
		$('#isNotUnit').removeClass("hidden");
	}else{
		$('#isNotUnit').addClass("hidden");
		$('#isUnit').removeClass("hidden");
	}
	// 开启多仓或者多单位关闭库存编辑
	if((pdaMultUnit=="1" || pdaMultUnit ==1)||(pdaStorage == "1" || pdaStorage == 1)){
		$('#tbQtyGroup').addClass("hidden");
	}else{
		$('#tbQtyGroup').removeClass("hidden");
	}
	
	// 加载数据
	$("#bootstrapTable").bootstrapTable({
        method: "post",
        url: "../../transitionServlet?method=getGoodsList",
        height: getTableHeight(),
        cache: false,
        pagination: true,
        pageSize: 10,
        pageList: [10,20,50,100,500,1000],
        sidePagination: "server",
        queryParamsType:"",
        queryParams: postQueryParams,
        showFooter: true,
        onLoadSuccess : function (data) {
        	// 加载完成后调整表格高
        	$('#bootstrapTable').bootstrapTable('resetView', {height: $(window).height() -  $("#bootstrapTable").offset().top - 2});
        	
            // 加载成功后获取页脚信息
        	$.each(data.footer, function(i, item) {
        		footerQty = formatMoney(item.Qty, pdaQtyScale);
        		footerCostMoney = formatMoney(item.CostMoney, pdaMoneyScale);
        		$("#footerQty").text(footerQty);
        		$("#footerCostMoney").text(footerCostMoney);
        	});
        	 var editStorage = document.getElementById('editStorage'); 
    		 var storageName ="";
    		 if(editStorage.options[editStorage.selectedIndex]!=null && editStorage.options[editStorage.selectedIndex]!=""){
    			 storageName = editStorage.options[editStorage.selectedIndex].value;
    			 if(storageName=="selectStorage"){
    				 storageName="";
    			 }
    		 }
    		 var editTag = document.getElementById('editTagGoods'); 
    		 var tagName = editTag.options[editTag.selectedIndex].value;
    		 if(tagName=="selectTagGoods"){
    			 tagName="";
    		 }
        	//高级筛选
    		advancedSearch=$("#bootstrapTable").AdSearch({
        		url: "../../transitionServlet?method=getGoodsList&storageName="+storageName+"&tagName="+tagName ,
        		Isadearch: isAdvancedSearch
        	});
        	
        	isDefaultSearch = false;
      	},
      	onLoadError: function (status, res) {
      		//高级筛选
    		advancedSearch=$("#bootstrapTable").AdSearch({
        		url: "../../transitionServlet?method=getGoodsList",
        		Isadearch: isAdvancedSearch
        	});
    		
      		isDefaultSearch = false;
      	},
		onDblClickRow: function (row, element) {
			// 开启多仓时暂时禁用编辑功能
			/*if (pdaStorage == "1" || pdaStorage == 1) {
				return;
			}*/
			// 定位行记录索引
			var currentPageData = $("#bootstrapTable").bootstrapTable("getData");
			$.each(currentPageData, function(i, item) {
				if (row.KID == item.KID) {
					curRowIndex = i;
				}
			});
			$("#upGoods").removeAttr("disabled");
			$("#nextGoods").removeAttr("disabled");
		    $("#indexGoods").html("第" + (curRowIndex+1) + "款");
			
			$('#tbKID').val(row.KID);
			$('#tbDescription').val(row.Description);
			$('#tbBarcode').val('');
			barSplit(row.Barcode);	
			$('#tbNumber').val(row.Number);
			$('#tbLocation').val(row.Location);
			$('#tbBrand').val(row.Brand);
			$('#tbCategory').val(row.Category);
			$('#tbClass').val(row.Class);
			$('#tbSeries').val(row.Series);
			$('#tbSalePrice').val(formatMoney(row.SalePrice, pdaMoneyScale));
			
			$('#tbQty').val(formatMoney(row.Qty, pdaQtyScale).replace(/,/g, ""));
			$('#tbCostPrice').val(formatMoney(row.CostPrice, pdaMoneyScale));				
			$('#tbRetailPrice').val(formatMoney(row.RetailPrice, pdaMoneyScale));
			$('#tbRemark').val(row.Remark);
			$('#imagefile').val(""); // 文件浏览框赋空
			tbOldQty=formatMoney(row.Qty, pdaQtyScale); //旧库存
			tbOldCostPrice = formatMoney(row.CostPrice,pdaMoneyScale); // 旧价格
			enabled2DTable = (row.Enabled2DTable == "是" || row.Enabled2DTable == "1") ? true : false; // 是否为多单位货品
			
			$("#baseUnit").val(checkUnifined(row.BaseUnit));
			$(".base_unit01").html(checkUnifined(row.BaseUnit));
//			$('#basePrice').val(checkUnifined(formatMoney(row.BasePrice, pdaMoneyScale)));
//			$('#baseRetailPrice').val(checkUnifined(formatMoney(row.BaseRetailPrice, pdaMoneyScale)));
			$("#secondUnit").val(checkUnifined(row.SecondUnit));
			$(".second_unit01").html(checkUnifined(row.SecondUnit));
//			$('#secondPrice').val(checkUnifined(row.SecondPrice));
//			$('#secondRetailPrice').val(checkUnifined(formatMoney(row.SecondRetailPrice, pdaMoneyScale)));
			if(checkUnifined(row.BasePrice)!=""){
				$("#basePrice").val(checkUnifined(formatMoney(row.BasePrice,pdaMoneyScale).replace(/,/g, "")));
			}else{
				$("#basePrice").val("");
			}
			if(checkUnifined(row.BaseRetailPrice)!=""){
				$("#baseRetailPrice").val(checkUnifined(formatMoney(row.BaseRetailPrice,pdaMoneyScale).replace(/,/g, "")));
			}else{
				$("#baseRetailPrice").val("");
			}
			if(checkUnifined(row.SecondPrice)!=""){
				$("#secondPrice").val(checkUnifined(formatMoney(row.SecondPrice,pdaMoneyScale).replace(/,/g, "")));
			}else{
				$("#secondPrice").val("");
			}
			if(checkUnifined(row.SecondRetailPrice)!=""){
				$("#secondRetailPrice").val(checkUnifined(formatMoney(row.SecondRetailPrice,pdaMoneyScale).replace(/,/g, "")));
			}else{
				$("#secondRetailPrice").val("");
			}
			if(checkUnifined(row.UnitRatio1)!=""){
				$("#unitRatio1").val(checkUnifined(formatMoney(row.UnitRatio1,pdaQtyScale).replace(/,/g, "")));
			}else{
				$("#unitRatio1").val("");
			}
			$("#thirdUnit").val(checkUnifined(row.ThirdUnit));
			if(checkUnifined(row.ThirdPrice)!=""){
				$('#thirdPrice').val(checkUnifined(formatMoney(row.ThirdPrice, pdaMoneyScale)));
			}else{
				$('#thirdPrice').val("");
			}
			if(checkUnifined(row.ThirdRetailPrice)!=""){
				$('#thirdRetailPrice').val(checkUnifined(formatMoney(row.ThirdRetailPrice, pdaMoneyScale)));
			}else{
				$('#thirdRetailPrice').val("");
			}
//			$('#thirdRetailPrice').val(checkUnifined(formatMoney(row.ThirdRetailPrice, pdaMoneyScale)));
			if(checkUnifined(row.UnitRatio2)!=""){
				$("#unitRatio2").val(checkUnifined(formatMoney(row.UnitRatio2,pdaQtyScale).replace(/,/g, "")));
			}else{
				$("#unitRatio2").val("");
			}
			
			//			编辑时,不可以修改单位比例
			addAndRemoveUnitReadOnly();
			var goodsKID = row.KID;
			
			if (enabled2DTable) {
				$('#tbQty').attr("disabled", "disabled");
				$('#tbQty').attr("title", "此货品为二维商品，请在下面表格里修改库存。");
				
				if(pdaMultUnit=="1" || pdaMultUnit ==1){
					$('#isUnit').addClass("hidden");
					$('#isNotUnit').removeClass("hidden");
				}
				
				// 获取二维库存信息
				getGoodsDimension(goodsKID);
			} else {
				$("#DimensionContent").addClass("hidden");
				$("#divDimensionLoading").addClass("hidden");
				$('#tbQty').removeAttr("disabled");
				$('#tbQty').attr("title", "");
			}	
			
			//在线获取该货品的所有图片KID
			getImgesList(goodsKID);		
			
			// 打开编辑窗口
			$("#store").click();
			$('#baseGoodsModal').modal();
			$("#baseGoodsModal").multiUnit();
			selfAdaption();
		},
		onClickRow: function (row, element) {
			$("#bootstrapTable").bootstrapTable("uncheckBy", {
				field : "KID",
				values : [ row.KID ]
			});
			checkSelectRows();

		},
		onCheck: function (row) {
			checkSelectRows();
		},
		onUncheck: function (row) {
			checkSelectRows();
			checkAllCurrentRows = false;
		},
		onCheckAll: function (row) {
			checkSelectRows();
			checkAllCurrentRows = true;
		},
		onUncheckAll: function (row) {
			checkSelectRows();
			checkAllCurrentRows = false;
		}
    });
	
	// 绑定导出货品[全部货品]复选框的 change 事件
	/*$("#cb_goods").change(function() {
		var isCheck = $('#cb_goods').is(':checked');
		if (isCheck) {
			$('#exporttitle').html("确定导出<span style='color:red'>全部</span>货品？");
		}else {
			var kid = getSelectRows();
			$('#exporttitle').html("确定导出<span style='color:red'>" + kid.length + "</span>个货品？");
		}
	});*/
	 $(":radio").click(function(){
		var isCheck = $('input:radio[name=cb_goods]:checked').val();
		if (isCheck==-1) {
			$('#exporttitle').html("确定导出<span style='color:red'>全部</span>货品？");
		}else if(isCheck==1){
			$('#exporttitle').html("确定<span style='color:red'>按筛选条件</span>导出货品？");
		}else{
			var kid = getSelectRows();
			$('#exporttitle').html("确定导出<span style='color:red'>" + kid.length + "</span>个货品？");
		}
	 });
	
	// 绑定修改库存[全部货品]复选框的 change 事件
	$("#cb_allGoods").change(function() {
		var isCheck = $('#cb_allGoods').is(':checked');
		if (isCheck) {
			$('#stocks').html("已选中所有货品。");
		} else {
			var kid = getSelectRows();
			$('#stocks').html("已选中" + kid.length + "个货品。");
		}
	});
	
	$("#tagGoods").change(function() {
		 isDefaultSearch = true;
		 var editStorage = document.getElementById('editStorage'); 
		 var storageName ="";
		 if(editStorage.options[editStorage.selectedIndex]!=null && editStorage.options[editStorage.selectedIndex]!=""){
			 storageName = editStorage.options[editStorage.selectedIndex].value;
			 if(storageName=="selectStorage"){
				 storageName="";
			 }
		 }
		 var editTag = document.getElementById('editTagGoods'); 
		 var tagName = editTag.options[editTag.selectedIndex].value;
		 if(tagName=="selectTagGoods"){
			 tagName="";
		 }
		 
		$("#bootstrapTable").bootstrapTable("refresh", {url: "../../transitionServlet?method=getGoodsList&storageName="+storageName+"&tagName="+tagName });
		
	});
	$("#storage").change(function() {
		 isDefaultSearch = true;
		 var editStorage = document.getElementById('editStorage'); 
		 var storageName = editStorage.options[editStorage.selectedIndex].value;
		 if(storageName=="selectStorage"){
			 storageName="";
		 }
		 var editTag = document.getElementById('editTagGoods'); 
		 var tagName="";
		 if(editTag.options[editTag.selectedIndex]!=null && editTag.options[editTag.selectedIndex]!=""){
			 tagName= editTag.options[editTag.selectedIndex].value;
			 if(tagName=="selectTagGoods"){
				 tagName="";
			 }
		 }
		$("#bootstrapTable").bootstrapTable("refresh", {url: "../../transitionServlet?method=getGoodsList&storageName="+storageName+"&tagName="+tagName });
	});
	
	// 高级筛选显示隐藏（事件绑定）
	$("#goodsFilter").on("click",function(){
		advancedSearch.clean(0);
		if (isAdvancedSearch) {
			isAdvancedSearch = false;
			advancedSearch.hide(this);
		} else {
			isAdvancedSearch = true;
			advancedSearch.show(this);
		}
	});
	$(".table-multi input").on('focus',function(){
		$(this).select();
	});

	/*新增条码，删除条码*/
	var k = 0;
	$("#addBarcode").on('click',function(){
		var obj = $("#tbBarcode").val();
		var codeLen = $("#Barcodes").find(".barcode").length;		
		if ( obj !== '' ){
			$(".BarcodesQun").show();
			k++;
			$("#Barcodes").append("<div class='barcode bar"+ k +"'><em>"+ obj +"</em><span class='fa fa-close' onclick='delBarCode(this);'></span></div>");
			$(".BarcodesQun span").html( codeLen +1);
		}						
		 $("#tbBarcode").val('');
		 return k;
	});
	$(".BarcodesQun").off('click').on('click',function(){
		$(".BarcodesQun .fa-angle-down").toggleClass("up");
		$("#Barcodes").slideToggle();
	});
	
	
	
	
	
});


/**
 * checkUnifined
 * 处理空集合
 * @param {type} param 
 */
 function checkUnifined(param) {
 	if( null==param || param=="undefined" || param=="NaN.undefined"){
 		return "";
 	}else{
 		return param;
 	}
 }

/**
 * 获取仓库集
 * @param operatorKID
 */
function getStorage(operatorKID) {
	$.ajax({
		url: "../../transitionServlet?method=getStorage",
		type: "post",
		dataType: "json",
		success: function(data, textStatus) {
			var error=data.error;
			if(error){
				$.messager.popup(error);
				return;
			}
			
			var html = "";
			html ="<option value='selectStorage'>所有仓库</option>";
			$.each(data.BaseStorage, function(i, item) {
				html += "<option value='" + item.StorageKID + "'>" + item.StorageName + "</option>";
			});
			
			$("#editStorage").html(html);
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			$.messager.popup("网络异常");
		}
	});
}

/**
 * 获取标签集
 * @param operatorKID
 */
function getTagGoods(operatorKID) {
	$.ajax({
		url: "../../transitionServlet?method=getTagGoods",
		type: "post",
		dataType: "json",
		success: function(data, textStatus) {
			var error=data.error;
			if(error){
				$.messager.popup(error);
				return;
			}
			var no = data.BaseTagGoods.length;
			if(no == 0){
				$('#tagGoods').addClass("hidden");
			}
			var html = "";
			html ="<option value='selectTagGoods'>所有标签</option>";
			$.each(data.BaseTagGoods, function(i, item) {
				html += "<option value='" + item.TagKID + "'>" + item.TagName + "</option>";
			});
			
			$("#editTagGoods").html(html);
			
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			$.messager.popup("网络异常");
		}
	});
}




/**
 * 获取表格高度
 * @returns {Number}
 */
function getTableHeight() {
	return $(window).height() -  $("#bootstrapTable").offset().top - 2;
}

/**
 * 按回车执行搜索
 */
function enterPress(e) {
	var e = e || window.event;  
    if (e.keyCode == 13) {
    	doSearch();
    }
}

/**
 * 查询数据
 */
function doSearch() {
	isDefaultSearch = true;
	if(isAdvancedSearch){
		document.getElementById("goodsFilter").click(); 
		isAdvancedSearch = false;
	}
	 var editStorage = document.getElementById('editStorage'); 
	 var storageName ="";
	 if(editStorage.options[editStorage.selectedIndex]!=null && editStorage.options[editStorage.selectedIndex]!=""){
		 storageName = editStorage.options[editStorage.selectedIndex].value;
		 if(storageName=="selectStorage"){
			 storageName="";
		 }
	 }
	 var editTag = document.getElementById('editTagGoods'); 
	 var tagName = editTag.options[editTag.selectedIndex].value;
	 if(tagName=="selectTagGoods"){
		 tagName="";
	 }
	$("#bootstrapTable").bootstrapTable("refresh", {url: "../../transitionServlet?method=getGoodsList&storageName="+storageName+"&tagName="+tagName });
}



/**
 * 设置查询参数（增加参数）
 * 
 * @param params
 * @returns params
 */
function postQueryParams(params) {
    params.startDate = $("#startDate").val();
    params.endDate = $("#endDate").val();
    params.isAdvancedSearch = !isDefaultSearch && isAdvancedSearch;
    $("#searchText").val() ? searchVal = $("#searchText").val() : searchVal = '';
    if(!isDefaultSearch && isAdvancedSearch) {
    	advancedSearch.clean(1);
    	params.searchText = advancedSearch.getData();
    } else {
    	params.searchText = $.trim(searchVal);    
    }
    
    pageSize=params.pageSize;
    pageNumber=params.pageNumber;
    sortName=params.sortName;
    sortOrder=params.sortOrder;
    myIsAdvancedSearch=params.isAdvancedSearch;
    startDate=$("#startDate").val();
    endDate=$("#endDate").val();
    searchText=params.searchText;
    return params;
}
/**
 * 显示行号
 * 
 * @param value 字段的值
 * @param row 行数据
 * @param index 行索引
 * @returns
 */
function showRowsNumber(value, row, index) {
	var options = $("#bootstrapTable").bootstrapTable("getOptions");
	if (options.pageNumber > 1) {
		return index + (options.pageNumber - 1) * options.pageSize + 1;
	} else {
		return index + 1;
	}
}

/**
 * 合计页脚
 * 
 * @param data
 * @returns {String}
 */
function totalTextFooterFormatter(data) {
	return "合计";
}

/**
 * 库存页脚
 * 
 * @param data
 * @returns
 */
function qtyFooterFormatter(data) {
	return "<span id='footerQty'>" + footerQty + "</span>";
}

/**
 * 成本额页脚
 * 
 * @param data
 * @returns
 */
function costMoneyFooterFormatter(data) {
	return "<span id='footerCostMoney'>" + footerCostMoney + "</span>";
}

/**
 * 库存格式化
 * 
 * @param value 字段的值
 * @param row 行数据
 * @param index 行索引
 * @returns
 */
function formatQty(value, row, index) {
	if (parseFloat(value) < 0) {
		return '<span style="color:red;">' + formatMoney(value, pdaQtyScale) + '</span>';
	} else {
		return formatMoney(value, pdaQtyScale);
	}
}

/**
 * 价格金额格式化
 * 
 * @param value 字段的值
 * @param row 行数据
 * @param index 行索引
 * @returns
 */
function formatPrice(value, row, index) {
	if (value) {
		return formatMoney(value, pdaMoneyScale);
	}
}

/**
 * 显示是否二维货品
 */
function formatEnabled2DTable(value, row, index){
	if(value=="是"){
		return [
	                '<div style="color:#339933"><i class="fa fa-check"></i></div>'
	                ].join('');
	}	
}
/**
 * 显示货品图片
 * 
 * @param value 字段的值
 * @param row 行数据
 * @param index 行索引
 * @returns {String}
 */
function showImage(value, row, index){
	return "<a href='javascript:showLagerImage(\"" + value + "\", \"" + row.KID + "\")' title='点击查看大图'><img width='40' height='50' src='../../downImage?imageKid=" + value + "' onerror=\"this.src='../../images/noimage.jpg'\"/></a>";
}

/**
 * 显示大图
 * @param val
 */
function showLagerImage(imageKID, goodsKID) {
	if (!imageKID || imageKID == "null" || imageKID == "") {
		return;
	}

	showProcessModal("正在获取图片信息，请稍候...");
	// 获取图片KID列表
	$.ajax({
    	url: "../../GoodsServlet?method=getGoodsImgKID&goodsKID=" + goodsKID,
 	    type: "post",
 	    dataType: "json",
 	    success: function (data, textStatus) {
 		    if (data.error) {
 		    	hideProcessModal();
 		    	imageKIDList = [];
 		    	return;
 		    }
 		    
 		   imageKIDList = [];
	       $.each(data.ImageKIDList, function(i, item) {
	    	   imageKIDList.push(item.imageKID); 
	       });
	       
	       hideProcessModal();
	       showCarousel(imageKID, imageKIDList);
 	   },
 	   error: function(XMLHttpRequest, textStatus, errorThrown) {
 		  imageKIDList = [];
 		  hideProcessModal();
 	   }
	});
}

/**
 * 新增货品
 */
function addGoods(){
	//单位比例添加时可以修改比例
	$('#unitRatio1').removeAttr("readonly");
	$('#unitRatio2').removeAttr("readonly");
	isAddGoods = true;
	curRowIndex=0;
	var guid = UUID.prototype.createUUID();
	IsDimensionOne = false;// 是否存在维度1
	IsDimensionSec = false;// 是否存在维度2
	isModestock = true; 	
	// 控件状态
	if (pda2DTable) {		
		enabled2DTable=pda2DTable;
		$("#goodsIsOrder").val("0");
		$("#DimensionContent").removeClass("hidden");
		$("#divDimensionLoading").addClass("hidden");
		
		$('#tbQty').attr("disabled", "disabled");
		$('#tbQty').attr("title", "此货品为二维商品，请在下面表格里修改库存。");
	} else {
		$("#DimensionContent").addClass("hidden");
		$("#divDimensionLoading").addClass("hidden");
		$('#tbQty').removeAttr("disabled");
		$('#tbQty').attr("title", "");
	}
	$("#upGoods").removeAttr("disabled");
	$("#nextGoods").removeAttr("disabled");
	$("#indexGoods").html("新增货品");
	
	// 内容赋值
	$('#tbKID').val(guid);
	$('#tbDescription').val("");
	$('#tbBarcode').val("");
	$('#Barcodes .barcode').remove();
	$('#tbNumber').val("");
	$('#tbLocation').val("");
	$('#tbBrand').val("");
	$('#tbCategory').val("");
	$('#tbClass').val("");
	$('#tbSeries').val("");
	$('#tbQty').val("");
	$('#tbSalePrice').val("");
	$('#tbCostPrice').val("");
	$('#tbRetailPrice').val("");
	$('#tbRemark').val("");
	$('#imagefile').val("");
	$('#pd_img').attr("src","../../images/noimage.jpg"); 
	$("#DimensionTable").html("");
	$("#baseUnit").val('');
	$(".base_unit01").html('');
	$("#basePrice").val('');
	$("#baseRetailPrice").val('');
	$("#secondUnit").val('');
	$(".second_unit01").html('');
	$("#secondPrice").val('');
	$("#secondRetailPrice").val('');
	$("#unitRatio1").val('');
	$("#thirdUnit").val('');
	$("#thirdPrice").val('');
	$("#thirdRetailPrice").val('');
	$("#unitRatio2").val('');
	// 隐藏缩略图
	for (var i = 0; i < 6; i++) {
		document.getElementById("div" + i).style.display = "none";
	}
	$("#store").click();
	$(".BarcodesQun").hide();
	$("#baseGoodsModal").modal();
	$("#baseGoodsModal").multiUnit();
	selfAdaption();
}

/**
 * 获取选择的行动态改变按钮状态
 */
function checkSelectRows(){
	var kid = getSelectRows();
	if (kid.length > 0) {
		$('#btnDeletd').removeAttr("disabled");
	} else {
		$('#btnDeletd').attr("disabled", "disabled");
	}
}

/**
 * 获取已选择
 * @returns {Array}
 */
function getSelectRows(){
	var kid = [];
	var rows = $('#bootstrapTable').bootstrapTable('getSelections'); // 取得所有选择的行
	if (rows.length > 0) {
		for (var i = 0; i < rows.length; i++) {
			kid.push(rows[i].KID);
		}
	}
	return kid;
}

/**
 * 获取已选择用于判断批量修改库存
 * @returns {Array}
 */
function getSelectRowsStock(){
	var params = [];
	var rows = $('#bootstrapTable').bootstrapTable('getSelections'); // 取得所有选择的行
	if (rows.length > 0) {	
		for (var i = 0; i < rows.length; i++) {
			var data={};
			data.goodsKID=rows[i].KID
			data.enabled2DTable=rows[i].Enabled2DTable=='是'? true:false;
			params.push(data);
		}
	}
	return params;
}


/**
 * 获取二维货品库存
 * @param goodsKID
 */
function getGoodsDimension(goodsKID) {
	IsDimensionOne = false; // 是否存在维度1
	IsDimensionSec = false; // 是否存在维度2
//	$("#divDimensionLoading").removeClass("hidden"); // 显示加载中
//	$("#DimensionContent").addClass("hidden"); // 二维表
	// 获取商品二维信息
	$.ajax({
    	url: "../../GoodsDimensionServlet?method=getGoodsDimension&goodsKID=" + goodsKID,
	 	type: "post",
	 	dataType: "json",
	 	success: function(data, textStatus) {
	 		// 非当前处理商品时不处理（可能用户网络不怎么好并且切换过快）
	 		if ($("#tbKID").val() != goodsKID) {
	 			return;
	 		}
	 		
	 		// 检查商品是否下过单
	 		checkGoodsIsOrder();
	 		
	 		if(data.error) {
	 			$("#DimensionTable").html("");
	 			$("#DimensionContent").removeClass("hidden");
		 		$("#divDimensionLoading").addClass("hidden");
	 			return;
	 		}
	 		
	 		if (data.rows.length == 0) {
	 			$("#DimensionTable").html("");	
	 			$("#DimensionContent").removeClass("hidden");
		 		$("#divDimensionLoading").addClass("hidden");
				return;
	 		}
	 		
			IsDimensionOne = true;// 是否存在维度1
			IsDimensionSec = true;// 是否存在维度2
			
			// 加载二维表格
			loadDimensionTable(data);
	 	
		  	// 二维表加载完后，显示颜色、尺码按钮
		  	$("#DimensionContent").removeClass("hidden");
		  	
		  	// 隐藏加载中
		  	$("#divDimensionLoading").addClass("hidden");
		  	
			if (pda2DTable) {
				$('.one_Name').removeClass("hidden");
				$('.sec_Name').removeClass("hidden");
			} else {
				$('.one_Name').addClass("hidden");
				$('.sec_Name').addClass("hidden");
			}	
		  	
	 	},
	 	error: function(XMLHttpRequest, textStatus, errorThrown) {
	 		if ($("#tbKID").val() == goodsKID) {
	 			$("#DimensionContent").addClass("hidden");
		 		$("#divDimensionLoading").addClass("hidden");
		 		$("#DimensionTable").html("");
		 		$.messager.popup("加载数据失败。");
	 		}
	 	}
	});
}

/**
 * 检查商品有没有下过单，有下过单的维度不允许删除
 */
function checkGoodsIsOrder() {
	$("#goodsIsOrder").val("0");
	var goodsKID = $("#tbKID").val();
	
	$.ajax({
		url: "../../GoodsDimensionServlet?method=getGoodsOrderState&goodsKID=" + goodsKID,
		type: "post",
		dataType: "json",
		async: false, // false 为同步 
		success : function(data, textStatus) {
			if (data.error) {
				return;
			}
			
			if (data.isOrder) {
				$("#goodsIsOrder").val("1");
			} else {
				$("#goodsIsOrder").val("0");
			}
		},
		error:function(XMLHttpRequest, textStatus, errorThrown) {
			// do nothing
		}
	});
}

/**
 * 加载商品二维表格
 * 
 * @param data
 */
function loadDimensionTable(data) {
	// 清空二维表格
	$("#DimensionTable").html("");
	
	// 商品有没有下过单
	var isOrder = $("#goodsIsOrder").val() == "1" ? true : false;
	
	// 纵坐标列数
	var columnCount = 0; 
	// 维度二标题
	var columnTitle = new Array();
	// 二维表HTML内容
	var $content = new Array([""]);
	
	var dimOneKIDList = new Array(); // 横坐标KID列表
	var dimOneNameList = new Array(); // 横坐标维度名称列表
	var dimOneQtyList = new Array(); // 横坐标库存列表
	
	// 纵坐标标题
	$content.push('<TR name="head" > '); 
	$content.push('<TD>&nbsp;</TD> '); 
	
	var beginSort = data.rows[0].Sort.split("-"); // 开始的坐标
	var beginRow = beginSort[0]; // 开始行坐标值
	
	$.each(data.rows, function(i, item) {
		var dimSort= (item.Sort).split("-");
		var rowIndex = dimSort[0];
		
		if(rowIndex == beginRow) {
			if (columnTitle.indexOf(item.DimSec) == -1) {
				columnTitle.push(item.DimSec);
				parseInt(columnCount++, 0);
				$content.push(' <TD name="dstitle" id="' + item.DimSecKID + '" >' + item.DimSec + '</TD> ');
			}
		}
		
		// 算出多少行
		if (dimOneKIDList.indexOf(item.DimOneKID) == -1) {
			dimOneKIDList.push(item.DimOneKID);
			dimOneNameList.push(item.DimOne);
		}
	});
	
	// 库存内容
	for (var i = 0; i < dimOneKIDList.length; i++) {			
		$.each(data.rows, function(j, item) {
			if (item.DimOneKID == dimOneKIDList[i]) {
				if (!dimOneQtyList[i]) {
					dimOneQtyList[i] = "";
				}
				dimOneQtyList[i] += '<TH id="' + item.KID + '" name="' + item.Sort + '" ><input type="text"  value="' + formatMoney(item.Qty, pdaQtyScale) + '" ></TH>';
			}
		});
	}
	
	// 纵坐标合计标题
	$content.push(' <TD  id="" >合计</TD> ');
	$content.push('</TR> '); 
	
	// 维度内容
	for (var i = 0; i < dimOneKIDList.length; i++) {
		$content.push('<TR name="content">');
		if (isOrder) {
			$content.push('<TD name="dotitle" class="td_read_only" width="110px" id="' + dimOneKIDList[i] + '" >' + dimOneNameList[i] + '</TD>');
		} else {
			$content.push('<TD name="dotitle" width="110px" id="' + dimOneKIDList[i] + '" >' + dimOneNameList[i] + '</TD>');
		}
		
		$content.push(dimOneQtyList[i]);
		$content.push('<TH id="" width="120px" name="totaly"></TH>');
		$content.push('</TR >');
	}
	
	// 页脚合计
	$content.push('<TR name="footer">');
	$content.push('<TD id="" width="110px" >合计</TD>');
	
	for (var i = 0; i <= columnCount - 1; i ++) {
		$content.push('<TH id="" name="totalx"></TH>');
	}
	
	$content.push('<TH id=""  name="total"></TH>');
	$content.push('</TR >');
	
	// 追加二维table内容
	$("#DimensionTable").html($content.join(''));
	// 键盘事件绑定
	CalculateDimension();
	// 重新计算合计
	RecCalculate();
}

/**
 * input 事件绑定用于计算二维表
 * @param $table
 */
function  CalculateDimension(){
	var $table = $("#DimensionTable").find("input");
	$table.each(function(q) {
		//绑定keyup修改库存事件
		$(this).keydown(function(e) {
			if (!isNumber(e.keyCode) ) {
				$.messager.popup("只能输入数字");
				return false;
			}
		});
		
		$(this).keyup(function(e) {
			RecCalculate();
		});
	});		
}

/**
 * 重新统计二维表
 */
function RecCalculate() {	
	var inputval = 0; // 总数
	
	// 统计列
	$("TD[name='dstitle']").each(function(i) {
		var inputvaly = 0; // 列
		$("#DimensionTable").find("TH[name$='-" + i + "']").each(function() {
			inputvaly += parseFloat($(this).find("input").val());
		});
		
		$("#DimensionTable").find("TH[name='totalx']").eq(i).html(inputvaly);		
	});
	
	// 统计行
	$("TD[name='dotitle']").each(function(i) {
		var inputvalx = 0; // 行
		
		$(this).nextAll().find("input").each(function() {
			inputvalx += parseFloat($(this).val());
		});
		
//		$("#DimensionTable").find("TH[name^='" + i + "-']").each(function() {
//			inputvalx += parseFloat($(this).find("input").val());
//		});		
		
		$("#DimensionTable").find("TH[name='totaly']").eq(i).html(inputvalx);		
	});
	
	// 总合计
	$("#DimensionTable").find("TH[name='totalx']").each(function(){
		inputval += parseFloat($(this).html());
	});
	
	$("TH[name='total']").html(inputval);	
	$("#tbQty").val(inputval);
}

/**
 * 
 * @returns {Array}
 */
/*
 *处理二维表数据，转数组类型
 */
function HandleDimensionData(){
	var $Dimension = $("#DimensionTable");
	var $tbDimension = $Dimension.find("TH[name*='-']");// 统计input
	var $tbDimensionx = $Dimension.find("TH[name='totalx']");// X统计行
	var $tbDimensiony = $Dimension.find("TH[name='totaly']");// Y统计行
	var $tbDimensiontTotal = $("TH[name='total']");// 总量
	var params = new Array();
	
	// 循环input内容值
	$tbDimension.each(function(){
		var dataMap ={};	
		dataMap.id = $(this).attr("id");
		dataMap.qty=parseFloat($(this).children().val());
		dataMap.dimone=$(this).siblings("td[name='dotitle']").html();
		dataMap.dimonekid=$(this).siblings("td[name='dotitle']").attr("id");
		var index=parseInt($(this).index());
		dataMap.dimsec=$Dimension.find("td[name='dstitle']").eq(index-1).html();
		dataMap.dimseckid=$Dimension.find("td[name='dstitle']").eq(index-1).attr("id");
		dataMap.sort=$(this).attr("name");	
		params.push(dataMap);
	});
	
	/*
	 ---------- 现在版本不保存合计数据 2016-06-29 「Begin」----------
	// 循环维度x
	$tbDimensionx.each(function(index){
		var dataMap ={};	
		dataMap.id = $(this).attr("id");
		dataMap.qty = parseFloat($(this).html());
		dataMap.dimone="合计";
		dataMap.dimonekid="-1";
		dataMap.dimsec=$Dimension.find("td[name='dstitle']").eq(index).html();
		dataMap.dimseckid=$Dimension.find("td[name='dstitle']").eq(index).attr("id");
		dataMap.sort=""+max_x+"-"+index+"";
		params.push(dataMap);
	});
	
	// 循环维度y
	$tbDimensiony.each(function(index){
		var dataMap ={};
		dataMap.id = $(this).attr("id");
		dataMap.qty = parseFloat($(this).html());
		dataMap.dimone=$(this).siblings("td[name='dotitle']").html();
		dataMap.dimonekid=$(this).siblings("td[name='dotitle']").attr("id");
		dataMap.dimsec="合计";
		dataMap.dimseckid="-1";
		dataMap.sort=""+index+"-"+max_y+"";
		params.push(dataMap);
	});
	
	// 总量
	var dataMap ={};	
	dataMap.id = $tbDimensiontTotal.attr("id");
	dataMap.qty=parseFloat( $tbDimensiontTotal.html());
	dataMap.dimone="合计";
	dataMap.dimonekid="-1";
	dataMap.dimsec="合计";
	dataMap.dimseckid="-1";
	dataMap.sort=""+max_x+"-"+max_y+"";
	params.push(dataMap);
	
	---------- 现在版本不保存合计数据 2016-06-29 「End」----------
	*/
		
	return params;
}	

/**
 * 获取维度一
 * 
 * @param _this
 */
function CreateDimensionOne(_this) {
	if (cacheDimensionOneData != "") {
		loadDimensionOne(cacheDimensionOneData);
		return;
	}
	
	var $_this = $(_this);
	$_this.attr("disabled", "disabled");
	$_this.find("i").addClass("fa-spinner fa-spin");
	
	$.ajax({
		url: "../../GoodsDimensionServlet?method=getEnterpriseDimension&enterpriseDimensionKID=" + $_this.attr("id"),
	 	type: "post",
	 	dataType: "json",
	 	success: function(data, textStatus) {
	 		$_this.removeAttr("disabled");
	 		$_this.find("i").removeClass("fa-spinner fa-spin");
	 		
	 		cacheDimensionOneData = JSON.stringify(data);
	 		loadDimensionOne(cacheDimensionOneData);
	 	},
	 	error: function(XMLHttpRequest, textStatus, errorThrown) {
	 		cacheDimensionOneData = "";
	 		$_this.removeAttr("disabled");
	 		$_this.find("i").removeClass("fa-spinner fa-spin");
	 		$.messager.popup("加载数据失败。");
	 	}
	});
}

/**
 * 加载维度一数据
 * 
 * @param jsonString 企业维度一 json 数据
 */
function loadDimensionOne(jsonString) {
	var data = JSON.parse(jsonString);
	var $content = new Array([""]); // 维度组和维度值
	var $dotitle = $("td[name='dotitle']"); // 商品二维表左边的维度值
	var $dimension = $(".selectdimensionone"); // 外层 Div
	
	$.each(data.group, function(i, item) {
		// 添加维度组
		$content.push('<h4 style="font-size:16px" id="' + item.KID + '" >' + item.DimensionGroup + '</h4>');
		
		var valueList = data.value; // 维度值
		var valueSelected = false; // 维度值是否已经被选择
		var brString = ""; // 换行字符串（每行占两个 <br/>）
		var elementCount = 0; // 统计多少个维度值
		
		// 循环维度组下面的值
		for (var i = 0; i < valueList.length; i++) {		 			
			if (item.Code == valueList[i].EnterpriseDimensionGroupCode) {
				if ($dotitle.length > 0) {
					valueSelected = false;
					for (var j = $dotitle.length; j > 0; j--) {
						if (valueList[i].KID == $dotitle[j - 1].id) {
							if ($($dotitle[j - 1]).hasClass("td_read_only")) {
								$content.push('<span class="select span_read_only" id="' + valueList[i].KID + '" data-toggle="tooltip" title="' +  valueList[i].EnterpriseDimensionValue + '">' + valueList[i].EnterpriseDimensionValue + '</span>');
							} else {
								$content.push('<span class="select" id="' + valueList[i].KID + '" data-toggle="tooltip" title="' +  valueList[i].EnterpriseDimensionValue + '">' + valueList[i].EnterpriseDimensionValue + '</span>');
							}
							
							valueSelected = true;
						}
					 }
					
					 if(!valueSelected) {
						 $content.push('<span id="' + valueList[i].KID + '" data-toggle="tooltip" title="' +  valueList[i].EnterpriseDimensionValue + '">' + valueList[i].EnterpriseDimensionValue + '</span>');
					 }
				} else {
					$content.push('<span id="' + valueList[i].KID + '" data-toggle="tooltip" title="' +  valueList[i].EnterpriseDimensionValue + '">' + valueList[i].EnterpriseDimensionValue + '</span>');
				}
				
				elementCount++;
				if (elementCount % 8 == 0) {
					brString += "<br/><br/>";
				}
			}
		}
		$content.push("<br/><br/><br/>" + brString);
	 });
	
	$dimension.html("");
	$dimension.html($content.join(''));
	
	// 绑定维度值单击事件
	var $select = $(".selectdimensionone").find("span");
	$select.unbind("click");
	$select.bind("click", function() {
		// 下过单的，不可移除
		if ($(this).hasClass("span_read_only")) {
//			$.messager.popup("【" + $(this).html() + "】不可移除。");
			$.messager.popup("已下过单，不能删除！");
			return;
		}
		
		$(this).toggleClass("select");
	});
	
	// 显示维度选择 Modal
	$('#DimensionGoodsModalOne').modal();	
}

/**
 * 获取维度二
 * 
 * @param _this
 */
function CreateDimensionSec(_this){
	if (cacheDimensionSecData != "") {
		loadDimensionSec(cacheDimensionSecData);
		return;
	}
	
	var $_this = $(_this);
	$_this.attr("disabled", "disabled");
	$_this.find("i").addClass("fa-spinner fa-spin");
	
	$.ajax({
    	url: "../../GoodsDimensionServlet?method=getEnterpriseDimension&enterpriseDimensionKID=" + $_this.attr("id"),
	 	type: "post",
	 	dataType: "json",
	 	success: function(data, textStatus) {
	 		$_this.removeAttr("disabled");
	 		$_this.find("i").removeClass("fa-spinner fa-spin");
	 		
	 		cacheDimensionSecData = JSON.stringify(data);
	 		loadDimensionSec(cacheDimensionSecData);
	 	},
	 	error: function(XMLHttpRequest, textStatus, errorThrown) {
	 		cacheDimensionSecData = "";
	 		$_this.removeAttr("disabled");
	 		$_this.find("i").removeClass("fa-spinner fa-spin");
	 		$.messager.popup("加载数据失败。");
	 	}
	});	
}

/**
 * 加载维度二数据
 * 
 * @param jsonString 企业维度二 json 数据
 */
function loadDimensionSec(jsonString) {
	var data = JSON.parse(jsonString);
	var $content = new Array([""]); // 维度组和维度值
	var $dstitle = $("td[name='dstitle']"); // 商品二维表左边的维度值
	var $dimension = $(".selectdimensionsec"); // 外层 Div
	
	// 商品有没有下过单
	var isOrder = $("#goodsIsOrder").val() == "1" ? true : false;
	
	$.each(data.group, function(i, item) {
		// 添加维度组
		if (isOrder) {
			$content.push('<div id="group"> <label class="checkbox" data-toggle="tooltip" title="已下过单，不能删除！"><input  type="checkbox" disabled="disabled"  id="' + item.KID + '" >' + item.DimensionGroup + '</label>');
		} else {
			$content.push('<div id="group"> <label class="checkbox"><input  type="checkbox" id="' + item.KID + '" >' + item.DimensionGroup + '</label>');
		}
		
		var valueList = data.value; // 维度值
		var valueSelected = false; // 维度值是否已经被选择
		var brString = ""; // 换行字符串（每行占两个 <br/>）
		var elementCount = 0; // 统计多少个维度值（每隔7个元素换一次行）
		
		// 循环维度组下面的值
		for(var i = 0; i < valueList.length; i++) {		 			
			if(item.Code == valueList[i].EnterpriseDimensionGroupCode) {
				if($dstitle.length > 0) {	
					valueSelected = false;
					for(var j = $dstitle.length; j > 0; j--) {
						if(valueList[i].KID == $dstitle[j-1].id) {
							$content.push('<span class="select" id="' + valueList[i].KID + '" data-toggle="tooltip" title="' +  valueList[i].EnterpriseDimensionValue +  '" >' + valueList[i].EnterpriseDimensionValue + '</span>');	
							valueSelected = true;
						}				
					 }
					
					if (!valueSelected) {
						$content.push('<span id="' + valueList[i].KID + '" data-toggle="tooltip" title="' +  valueList[i].EnterpriseDimensionValue +  '" >' + valueList[i].EnterpriseDimensionValue + '</span>');
					}
				} else {
					$content.push('<span id="' + valueList[i].KID + '" data-toggle="tooltip" title="' +  valueList[i].EnterpriseDimensionValue +  '" >' + valueList[i].EnterpriseDimensionValue + '</span>');
				}
				
				elementCount++;
				if (elementCount % 8 == 0) {
					brString += "<br/><br/>";
				}
			}		
		}
		
		$content.push("</div><br/><br/>" + brString);
	});
	
	$dimension.html("");
	$dimension.html($content.join(''));
	
	// 以组为单位选择维度值
	if ($dstitle.length > 0) {
		// 匹配 class 为 select 的所有同辈 label 元素下面的 input 元素
		var $checkselect = $(".select").siblings("label").find("input");
		$checkselect.attr("checked", "true");
	}
	
	// 绑定维度值的单击事件
	var $check = $(".selectdimensionsec").find("input");
	$check.unbind("click");
	$check.bind("click", function(event) {
		if ($(this)[0].checked) {
			// 选择当前组的值
			$(this).parent().siblings().addClass("select");
			
			// 移除当前组以外的选择状态
			$(this).parent().parent().siblings().find("span").removeClass("select");
			$(this).parent().parent().siblings().find("input").removeAttr('checked');			 				
		} else {
			$(this).parent().siblings().removeClass("select");
		}
 	});
	
	// 显示维度选择 Modal
	$('#DimensionGoodsModalSec').modal();	
}

/**
 * 创建维度一
 * @returns {Boolean}
 */
 function SaveDimensionOne() {
	 var $newdimension = $("#DimensionTable").find("tbody");
//	 var $dimen= $(".selectdimensionone").find("span[class='select']");
	 var $dimen = $(".selectdimensionone").find("span[class*='select']");
	 
	 if ($dimen.length <= 0) {
		 $.messager.popup("至少必须选一个");
		 return false;
	 }
	 
	 IsDimensionOne = true;
	 var $content = new Array([""]);	
	 if(!IsDimensionSec) {
		 $content.push('<TR name="head"> '); 
 		 $content.push('<TD>&nbsp;</TD> '); 
 		 $content.push('  <td id="-1"> 合计</td>');			
		 $content.push('</TR>');
		 
		 $dimen.each(function(){
			 $content.push('<TR name="content">');			 
			 $content.push('<TD width="110px" id="' + $(this).attr("id") + '" name="dotitle">' + $(this).html() + ' </TD>');
			 $content.push('<TH id="' + new UUID() + '" width="120px" name="totaly"> 0 </TH>');	 
			 $content.push('</TR>');
		 });
		 
		 $content.push('<TR name="footer">');			 
		 $content.push('<TD id="-1" width="110px">合计</TD>');
		 $content.push('<TH id="' + new UUID() + '" name="total"> 0 </TH>');		 
		 $content.push('</TR>');
		 
		$("#DimensionTable").html($content.join(''));		
	 } else {  		 
		 var $dotitle = $("[name=dotitle]");
		 var $dstitle = $("td[name='dstitle']");
		 var $footer = $newdimension.children("TR[name='head']");
		 var $inputcontent = $newdimension.children("TR[name='content']");
		 var paramsKeep = [];
		 var paramsRemove = [];
		 var sortN = 0;
		 
		 // 找出添加的标签
		 $dimen.each(function() {
			 var _this1 = this;
			 var count = 0;
			 
			 $dotitle.each(function(){
				 var _this2 = this;
				 if(_this1.id == _this2.id){
					 count++;
				 }			
			 });
			 
			 // 记录新增元素
			 if(count == 0) {
				 paramsKeep.push(_this1);
			 }				
		 });
		 
		 // 找出删除的标签
		 $dotitle.each(function(){  
			 var _this1 = this;
			 var count = 0;
			 $dimen.each(function(){
				 var _this2 = this;
				 if(_this1.id == _this2.id){
					 count++;
				 }			
			 });
			 
			 // 记录需要删除的元素
			 if (count == 0) {
				 paramsRemove.push(_this1);
			 }				
		 });
		 
		 // 清除该元素的父元素 
		 $(paramsRemove).parent().remove();
		 
		 // 新增维度
		 $(paramsKeep).each(function(i){
			 $content.push('<TR name="content"> '); 
	 		 $content.push('<TD width="110px" id="' + $(this).attr("id") + '" name="dotitle">' + $(this).html() + '</TD>'); 
	 		 $dstitle.each(function(j) {
	 			 if ($inputcontent.length == 0) {
	 				 $content.push('<TH id="' + new UUID() + '" name="' + i + '-' + j + '"><input type="text" value="0"></TH>');
	 			 } else {
	 				 $content.push('<TH id="' + new UUID() + '" name="' + sortN + 1 + '-' + j + '"><input type="text" value="0"></TH>');
	 			 }
	 		 });	 		
	 		 $content.push('<TH id="' + new UUID() + '" width="120px" name="totaly">0</TH>');	 		 	
			 $content.push('</TR>');
 		});
		 
   		$footer.after($content.join(''));
   		// 重新排序 name='sort'属性值
   		$("TR[name='content']").each(function(i) {
   			_this = this;
   			$(_this).find("TH[name*='-']").each(function(j){
				$(this).attr("name", (i) + "-" + j);
			})
		});
   	}
	 
//	max_x = parseInt($dimen.length); // 最大维度一
	RecCalculate();
	CalculateDimension(); // 绑定计算
	$('#DimensionGoodsModalOne').modal("hide");
}
 
/**
 * 创建纬度二
 * @returns {Boolean}
 */
 function SaveDimensionSec() {	 	 
	 var $selectedDimension = $(".selectdimensionsec").find("span[class='select']");
	 var $tableBody = $("#DimensionTable").find("tbody");
	 
	 if($selectedDimension.length <= 0) {
		 $.messager.popup("至少必须选一个");
		 return false;
	 }
	 
	 var existCount = 0;
	 var $dsTitle = $("td[name='dstitle']");
	 $dsTitle.each(function(){  
		 var $_this1 = $(this);
		 
		 $selectedDimension.each(function() {
			 var $_this2 = $(this);
			 if($_this1.attr("id") == $_this2.attr("id")){
				 existCount++;
			 }
		 });
	 });
	 
	 // 选择相同的重复的不做操作
	 if (existCount > 0) {
		 $('#DimensionGoodsModalSec').modal("hide");
		 return;
	 }
	 
	 IsDimensionSec = true;
	 if(!IsDimensionOne) {
		 //不存在维度一，新增纬度二
		 var $content = new Array([""]);
		 $content.push('<TR name="head"> '); 
		 $content.push('<TD>&nbsp;</TD> '); 
		 
		 $selectedDimension.each(function() {
			 $content.push('<TD width="110px" id="' + $(this).attr("id") + '" name="dstitle">' + $(this).html() + '</TD>');
		 }); 
		 
		 $content.push('<TD id="-1" width="110px">合计</TD>');
		 $content.push('</TR>');
		 $content.push('<TR name="footer">');		
		 $content.push('<TD id="-1" width="110px">合计</TD>');
		 
		 $selectedDimension.each(function() {
			 $content.push('<TH id="'+new UUID()+'" name="totalx"> 0 </TH>');
		 });
		 
		 $content.push('<TH id="'+new UUID()+'" name="total"> 0 </TH>');
		 $content.push('</TR>');
		 
		 $("#DimensionTable").html($content.join(''));
	 } else {
		 $("th[name='totaly']").html("0");
		 $("th[name='total']").html("0");
		 $("th[name='totalx']").html("0");		
		 
		 var $head = $tableBody.children("TR:first-child").find("td:first-child");
		 var $dimcontent = $tableBody.children("TR[name='content']").find("td:first-child");
		 var $lasttotal = $tableBody.children("TR[name='footer']").find("td:first-child");		  	
		 
		 $tableBody.children("TR[name='head']").find("td[name='dstitle']").remove(); // 清除维度二标题
		 $tableBody.children("TR[name='content']").find("th[name!='totaly']").remove(); // 清除维度二内容
		 $tableBody.children("TR[name='footer']").find("th[name='totalx']").remove(); // 清除维度二统计	
		 
		 // 维度二标题
		 var $tdTitle = new Array([""]);
		 $selectedDimension.each(function() {
			 $tdTitle.push('<TD  id="' + $(this).attr("id") + '"name="dstitle">' + $(this).html() + '</TD>');
		 });
		 $head.after($tdTitle.join(''));
		 
		 // 列对应的输入框（每行）
		 $dimcontent.each(function(i) {
			 var $thInput = new Array([""]);
			 $selectedDimension.each(function(j) {
				 $thInput.push('<th id="' + new UUID() + '" name="' + i + '-' + j + '"><input type="text" value="0"></th>');
			 });
			 
			 $(this).after($thInput.join(''));
		 });
		 
		 // 统计
		 var $thTotal = new Array([""]);
		 $selectedDimension.each(function() {
			 $thTotal.push('<TH id="' + new UUID() + '" name="totalx">0</TH>');
		 }); 
		 $lasttotal.after($thTotal.join(''));
		  				
	 }
	 
//	 max_y = parseInt($selectedDimension.length); // 最大维度一
	 CalculateDimension(); // 绑定计算
	 $('#DimensionGoodsModalSec').modal("hide");
 }

/**
 * 关闭添加维度一窗口
 */
 function CancelDimensionOne(){
	 $('#DimensionGoodsModalOne').modal("hide");
 }
 /**
  * 关闭添加维度二窗口
  */
 function CancelDimensionSec(){
	 $('#DimensionGoodsModalSec').modal("hide");
 }
 
/**
 * 获取图片集合
 * @param goodsKID
 */
function getImgesList(goodsKID) {
	$('#pd_img').attr("src","../../images/noimage.jpg"); 
	// 隐藏缩略图
	for (var i = 0; i < 6; i++) {
		document.getElementById("div" + i).style.display = "none";
	}
	
	$.ajax({
    	url: "../../GoodsServlet?method=getGoodsImgKID&goodsKID=" + goodsKID,
	 	type: "post",
	 	dataType: "json",
	 	success: function(data, textStatus) {
	 		// 非当前处理商品时不处理（可能用户网络不怎么好并且切换过快）
	 		if ($("#tbKID").val() != goodsKID) {
	 			return;
	 		}
	 		
	 		if(data.error) {
	 			imageKIDList = [];
	 			return;
	 		}
	 		
	 		imageKIDList=[];
	 		$.each(data.ImageKIDList, function(i, item) {
	 			imageKIDList.push(item.imageKID); 
	 		});
	 		
	 		//缩略图
	 		if(imageKIDList.length > 1) {
	 			for(var i = 0; i < imageKIDList.length; i++){
					document.getElementById("div" + i).style.display = "";
					$('#img' + i).attr("src", "../../downImage?imageKid=" + imageKIDList[i]); 
				}
				
				for(var i = 5; i >= imageKIDList.length; i--) {
					document.getElementById("div" + i).style.display = "none";
				}
	 		} else {
				for(var i = 0; i < 6; i++) {
					document.getElementById("div" + i).style.display = "none";
				}
	 		}
				
			//大图
			if(imageKIDList.length > 0){
				$('#pd_img').attr("src", "../../downImage?imageKid=" + imageKIDList[imageKIDList.length - 1] + "&showRawImage=1"); 
			}
			else{
				$('#pd_img').attr("src", "../../images/noimage.jpg"); 
			}

	 	},
	 	error: function(XMLHttpRequest, textStatus, errorThrown) {
	 		imageKIDList = [];
	 	}
	});
}

/**
 * 上一项
 */
function upGoods() {
	if (curRowIndex == 0) {
//		showAlert("已经是当前页第一项");
		$.messager.popup("已经是当前页第一项");
	} else {
		var isCheck = $('#cb_auto').is(':checked');
		if (isCheck) {
			isSaveAuto = true;
			saveGoods(0);
			if(notUpGoods!=""){
				return;
			}
			changeGoods(curRowIndex-1);
		}else{
			isSaveAuto = false;
			curRowIndex--;
			changeGoods(curRowIndex);
		}
		
	}
}

/**
 * 下一项
 */
function nextGoods(){
	// 当前页数据
	var currentPageData = $("#bootstrapTable").bootstrapTable("getData");
	if (!isAddGoods && curRowIndex == currentPageData.length - 1) {
//		showAlert("已经是当前页最后一项");
		$.messager.popup("已经是当前页最后一项");
	} else {
		if(!isAddGoods){
			curRowIndex++;
		}
		var isCheck = $('#cb_auto').is(':checked');
		if (isCheck) {
			isSaveAuto = true;
			saveGoods(0);
			if(notUpGoods!=""){
				return;
			}
		}else{
			isSaveAuto = false;
			isAddGoods=false;
		}
		changeGoods(curRowIndex);
	}
}


/**
 * 下一项
 */
function nextWeiXinGoods(){
	// 当前页数据
	var currentPageData = $("#bootstrapTable").bootstrapTable("getData");
	if (curRowIndex == currentPageData.length - 1) {
//		showAlert("已经是当前页最后一项");
		$.messager.popup("已经是当前页最后一项");
	} else {
		curRowIndex++;
		var isCheck = $('#cb_auto').is(':checked');
		if (isCheck) {
			isSaveAuto = true;
			saveGoods(0);
		}else{
			isSaveAuto = false;
		}
		var currentPageData = $("#bootstrapTable").bootstrapTable("getData");
		$('#tbKID').val(currentPageData[curRowIndex]["KID"]);
		loadWeixinShop(currentPageData[curRowIndex]["KID"]);
	}
}

/**
 * 上一项
 */
function upWeiXinGoods() {
	if (curRowIndex == 0) {
//		showAlert("已经是当前页第一项");
		$.messager.popup("已经是当前页第一项");
	} else {
		curRowIndex--;
		var isCheck = $('#cb_auto').is(':checked');
		if (isCheck) {
			isSaveAuto = true;
			saveGoods(0);
		}else{
			isSaveAuto = false;
		}
		var currentPageData = $("#bootstrapTable").bootstrapTable("getData");
		$('#tbKID').val(currentPageData[curRowIndex]["KID"]);
		loadWeixinShop(currentPageData[curRowIndex]["KID"]);
	}
}
/**
 * 将条码拆分,以下拉的形式展示（跟PDA）
 * @param obj
 */
function barSplit(obj){	
	$("#Barcodes").hide();
	$('#Barcodes .barcode').remove();
	$(".BarcodesQun .fa-angle-down").removeClass("up");
	var barcode= new Array(); 
	if ( obj ){
		$(".BarcodesQun").show();
		barcode=obj.split("、"); 
		$(".BarcodesQun span").html( barcode.length );
		for (i=0;i<barcode.length ;i++ ) 
		{ 
			$("#Barcodes").append("<div class='barcode bar"+ i +"'><em>"+ barcode[i] +"</em><span class='fa fa-close'  onclick='delBarCode(this);'></span></div>");			
		} 		
	}else{
		$(".BarcodesQun").hide();
	}
}
/**
 * 删除对应条码
 * @param obj
 */
function delBarCode(obj){
	var len = $(obj).parents(".barcode").siblings().length;
	$(obj).parent().remove();
	if ( len === 0 ){
		$(".BarcodesQun").hide();
		$("#Barcodes").hide();
	}	
}
/**
 * 切换货品
 * @param index
 */
function changeGoods(index){
	if(isAddGoods){
		$("#indexGoods").html("第" + (curRowIndex+2) + "款");
		curRowIndex ++;
	}else{
		$("#indexGoods").html("第" + (curRowIndex+1) + "款");
		
	}
	isAddGoods = false;
	// 当前页数据
	var currentPageData = $("#bootstrapTable").bootstrapTable("getData");
	
	$('#tbKID').val(currentPageData[index]["KID"]);
	$('#tbDescription').val(currentPageData[index]["Description"]);
	$('#tbBarcode').val('');
	barSplit(currentPageData[index]["Barcode"]);	
	$('#tbNumber').val(currentPageData[index]["Number"]);
	$('#tbLocation').val(currentPageData[index]["Location"]);
	$('#tbBrand').val(currentPageData[index]["Brand"]);	
	$('#tbCategory').val(currentPageData[index]["Category"]);
	$('#tbClass').val(currentPageData[index]["Class"]);
	$('#tbSeries').val(currentPageData[index]["Series"]);
	$('#tbQty').val(formatMoney(currentPageData[index]["Qty"], pdaQtyScale).replace(/,/g, ""));
	$('#tbSalePrice').val(formatMoney(currentPageData[index]["SalePrice"], pdaMoneyScale).replace(/,/g, ""));
	$('#tbCostPrice').val(formatMoney(currentPageData[index]["CostPrice"], pdaMoneyScale).replace(/,/g, ""));
	$('#tbRetailPrice').val(formatMoney(checkUnifined(currentPageData[index]["RetailPrice"]), pdaMoneyScale).replace(/,/g, ""));
	$('#tbRemark').val(currentPageData[index]["Remark"]);
	tbOldQty=formatMoney(currentPageData[index]["Qty"], pdaQtyScale).replace(/,/g, ""); //旧库存
	tbOldCostPrice = formatMoney(currentPageData[index]["CostPrice"], pdaMoneyScale).replace(/,/g, ""); // 旧价格
	enabled2DTable = (currentPageData[index]["Enabled2DTable"] == "1" || currentPageData[index]["Enabled2DTable"] == "是") ? true : false; // 是否为多单位货品


	$("#baseUnit").val(checkUnifined(currentPageData[index]["BaseUnit"]));
	$(".base_unit01").html(checkUnifined(currentPageData[index]["BaseUnit"]));
	$('#basePrice').val(formatMoney(checkUnifined(currentPageData[index]["BasePrice"]), pdaMoneyScale).replace(/,/g, ""));
	$('#baseRetailPrice').val(formatMoney(checkUnifined(currentPageData[index]["BaseRetailPrice"]), pdaMoneyScale).replace(/,/g, ""));
	$("#secondUnit").val(checkUnifined(currentPageData[index]["SecondUnit"]));
	$(".second_unit01").html(checkUnifined(currentPageData[index]["SecondUnit"]));
	$('#secondPrice').val(formatMoney(checkUnifined(currentPageData[index]["SecondPrice"]), pdaMoneyScale).replace(/,/g, ""));
	$('#secondRetailPrice').val(formatMoney(checkUnifined(currentPageData[index]["SecondRetailPrice"]), pdaMoneyScale).replace(/,/g, ""));
	$("#unitRatio1").val(checkUnifined(currentPageData[index]["UnitRatio1"]));
	$("#thirdUnit").val(checkUnifined(currentPageData[index]["ThirdUnit"]));
	$('#thirdPrice').val(formatMoney(checkUnifined(currentPageData[index]["ThirdPrice"]), pdaMoneyScale).replace(/,/g, ""));
	$('#thirdRetailPrice').val(formatMoney(checkUnifined(currentPageData[index]["ThirdRetailPrice"]), pdaMoneyScale).replace(/,/g, ""));
	$("#unitRatio2").val(checkUnifined(currentPageData[index]["UnitRatio2"]));

	addAndRemoveUnitReadOnly();
	$('#imagefile').val("");
	var div = document.getElementById('preview');
	div.innerHTML = previewDiv;
	
	getImgesList(currentPageData[index]["KID"]);	
	if(enabled2DTable){
		getGoodsDimension(currentPageData[index]["KID"]);
		$('#tbQty').attr("disabled", "disabled");
		$('#tbQty').attr("title", "此货品为二维商品，请在下面表格里修改库存。");
	}else{
		$("#DimensionTable").html('');
		$("#DimensionContent").addClass("hidden");
		$("#divDimensionLoading").addClass("hidden");
		$('#tbQty').removeAttr("disabled");
		$('#tbQty').attr("title", "");
	}
}

/**
 * 复制新增
 */
function copyGoods(){
	var kid = $('#tbKID').val();
	if (iscopy) {
		var guid = UUID.prototype.createUUID();
		$('#tbKID').val(guid);
		$("#upGoods").attr("disabled", "disabled");
		$("#nextGoods").attr("disabled", "disabled");
		$("#indexGoods").html("当前款为复制新增款");
		$('#copyGoodsLabel').text("取消复制");
		
		$('#imagefile').val("");
		$('#pd_img').attr("src", "../../images/noimage.jpg"); 
		
		iscopy = false;
		
		$('#imagefile').val("");
		var div = document.getElementById('preview');
		div.innerHTML = previewDiv;
		   
		getImgesList(guid);
	} else {
		$('#tbKID').val(kid);
		$('#copyGoodsLabel').text("复制新增");
		$("#upGoods").removeAttr("disabled");
		$("#nextGoods").removeAttr("disabled");
		iscopy = true;
		changeGoods(curRowIndex);
	}
}

function saveWeiXinGoods(){
	showProcessModal("正在提交数据...");
	var tbKID = $('#tbKID').val();	
	var Title = $('#weixinTitle').val();	
	
	var WeiXinAuthorArr = $("input[name='WeiXinAuthor']");
	var WeiXinAuthor = "";
	for(var i=0;i<WeiXinAuthorArr.length;i++){
		if($(WeiXinAuthorArr[i]).is(':checked')){
			WeiXinAuthor += $(WeiXinAuthorArr[i]).val();
			break;
		}
	}
	
	var ShowEffectArr = $("input[name='ShowEffect']");
	var ShowEffect = "";
	for(var i=0;i<ShowEffectArr.length;i++){
		if($(ShowEffectArr[i]).is(':checked')){
			ShowEffect += $(ShowEffectArr[i]).val();
			break;
		}
	}
	
	var iframe = $("iframe")[0];
	var content = iframe.contentWindow.getContent(); //.getAllHtml();
	
	var checkbox = $("input[name='recommendGoods']");
	var recommendGoods = "";
	for(var i=0;i<checkbox.length;i++){
		if($(checkbox[i]).is(':checked')){
			recommendGoods += $(checkbox[i]).val()+",";
			break;
		}
	}
	var imgPr0 = $("#ImgPr0").attr("src");
	var imgPr1 = $("#ImgPr1").attr("src");
	var imgPr2 = $("#ImgPr2").attr("src");
	var imgPr3 = $("#ImgPr3").attr("src");
	var imgPr4 = $("#ImgPr4").attr("src");
	$.ajax({
		  url: ""+ basePath +"/GoodsServlet?method=saveWeiXinGoods",
		  type: "POST",
		  cache: false,
		  data:"tbKID="+ tbKID +"&Title="+ Title +"&WeiXinAuthor="+ WeiXinAuthor +"&ShowEffect="+ ShowEffect +"&content="+ content +"&recommendGoods="+ recommendGoods +"",
		  success: function(html){
			  $("#up").attr("disabled",true);
			  $("#showImg").ajaxSubmit(imageHandler(tbKID));
			  hideProcessModal();
		  }
	});
	return;
}

function imageHandler(tbKID){
	var options = {
			url: "../../GoodsServlet?method=saveWeiXinImage&goodsKID=" + tbKID,
			type: "post",
			success : function(data) {
				if (data) {
					$.messager.popup(data);
				}
				
				$('#imagefile').val("");
				var div = document.getElementById('preview');
				div.innerHTML = previewDiv;
				getImgesList(tbKID);
				doSearch();
			},
			error: function(XMLResponse) {
				$.messager.popup("上传图片失败！");
			}
	};
	return options;
}

/**
 * 检查多单位信息是否输入正确
 * @param {type} param 
 */
 function checkGoodsMultiUnit() {
	//显示
	var baseUnit = $.trim($('#baseUnit').val());
//	var basePrice = $.trim($('#basePrice').val().replace(/,/g, ""));
//	var baseRetailPrice = $.trim($('#baseRetailPrice').val().replace(/,/g, ""));
	
	var secondUnit = $.trim($('#secondUnit').val());
//	var secondPrice = $.trim($('#secondPrice').val().replace(/,/g, ""));
//	var secondRetailPrice = $.trim($('#secondRetailPrice').val().replace(/,/g, ""));
	var unitRatio1 = $.trim($('#unitRatio1').val());
	
	var thirdUnit = $.trim($('#thirdUnit').val().replace(/,/g, ""));
//	var thirdPrice = $.trim($('#thirdPrice').val().replace(/,/g, ""));
//	var thirdRetailPrice = $.trim($('#thirdRetailPrice').val().replace(/,/g, ""));
	var unitRatio2 = $.trim($('#unitRatio2').val());
	
	if (baseUnit !=null && baseUnit==""){return false;}     //基本單位的名稱不能为空	
  	//单位2 的名称与 比例可以同时为空/0, 表示没有单位2。但不能只有一个为空/0。
    if ((secondUnit=="" && (unitRatio1 != 0 && unitRatio1!="")) || (!secondUnit=="" && (unitRatio1 == 0 || unitRatio1==""))){
    	 return false;
    }
 	//单位3 的名称与 比例可以同时为空/0, 表示没有单位3。但不能只有一个为空/0。
    if ((thirdUnit=="" && (unitRatio2 != 0 && unitRatio2!="")) || (!thirdUnit=="" && (unitRatio2 == 0 || unitRatio2==""))){
    	return false;
    }
    //如果没有单位2，而有单位3，这种情况也是不正确的。
    if ((secondUnit=="" && (unitRatio1 == 0 || unitRatio1=="")) && (!thirdUnit=="" && (unitRatio2 != 0 && unitRatio2!=""))){
    	return false;
    }
    return true;
 }

/**
 * 保存货品
 */   
function saveGoods(val) {
	var tbKID = $('#tbKID').val();	
	var tbDescription = $.trim($('#tbDescription').val());
	var tbBarcode = $.trim($('#tbBarcode').val());
	var tbNumber = $.trim($('#tbNumber').val());
	var tbLocation = $.trim($('#tbLocation').val());
	var tbBrand = $.trim($('#tbBrand').val());
	var tbSalePrice = $.trim($('#tbSalePrice').val().replace(/,/g, ""));
	var tbCostPrice = $.trim($('#tbCostPrice').val().replace(/,/g, ""));
	var tbRetailPrice = $.trim($('#tbRetailPrice').val().replace(/,/g, ""));
	var tbQty = $.trim($('#tbQty').val().replace(/,/g, ""));
	var tbCategory = $.trim($('#tbCategory').val());
	var tbClass = $.trim($('#tbClass').val());
	var tbSeries = $.trim($('#tbSeries').val());
	var tbRemark = $.trim($('#tbRemark').val());
	var tbImage = $('#imagefile').val();
	var tbImageFiles = $('#imagefile')[0].files;
	
	var baseUnit = $.trim($('#baseUnit').val());
	var basePrice = $.trim($('#basePrice').val().replace(/,/g, ""));
	var baseRetailPrice = $.trim($('#baseRetailPrice').val().replace(/,/g, ""));
	
	var secondUnit = $.trim($('#secondUnit').val());
	var secondPrice = $.trim($('#secondPrice').val().replace(/,/g, ""));
	var secondRetailPrice = $.trim($('#secondRetailPrice').val().replace(/,/g, ""));
	var unitRatio1 = $.trim($('#unitRatio1').val());
	
	var thirdUnit = $.trim($('#thirdUnit').val().replace(/,/g, ""));
	var thirdPrice = $.trim($('#thirdPrice').val().replace(/,/g, ""));
	var thirdRetailPrice = $.trim($('#thirdRetailPrice').val().replace(/,/g, ""));
	var unitRatio2 = $.trim($('#unitRatio2').val());
	checkGoodsMultiUnit();
	if(pdaMultUnit=="1" && pdaMultUnit==1){
//		显示
		if (!checkGoodsMultiUnit()) {
//			alert("单位信息不完整，请补充完整!");
			$.messager.popup("单位信息不完整，请补充完整!");
			notUpGoods = "1";
			return;
		} else{
			notUpGoods = "";
		}
//		if(baseUnit !=null && baseUnit==""){
//			alert("单位信息不完整，请补充完整!");
//			return
//		}else if(secondUnit !=null && secondUnit==""){
//			alert("单位信息不完整，请补充完整!");
//			return
//		}else if(thirdUnit !=null && thirdUnit==""){
//			alert("单位信息不完整，请补充完整!");
//			return
//		}
	}
//	else{
//		if(padIsShowClass=='1' && tbClass !=null && tbClass==""){
//			alert("单位信息不完整，请补充完整!");
//			return
//		}
//		
//	}
	
	
	var barcodes="";
	$("#Barcodes .barcode").each(function(){
		barcodes+=$(this).text()+" 、 ";
	});
	if(tbBarcode!=null&&tbBarcode!=""){
		barcodes=tbBarcode+" 、 "+barcodes;
	}
	var dataGoods = {
		"KID": tbKID,
		"Description": tbDescription,
		"Barcode": tbBarcode,
		"Number": tbNumber,
		"Location": tbLocation,
		"Brand": tbBrand,
		"Barcodes": barcodes,
		"SalePrice": tbSalePrice == "" ? "0" : tbSalePrice,
		"CostPrice": tbCostPrice == "" ? "0" : tbCostPrice,
		"OldCostPrice": tbOldCostPrice == "" ? "0" : tbOldCostPrice.replace(/,/g, ""),
		"RetailPrice": tbRetailPrice == "" ? "0" : tbRetailPrice,
		"Qty": tbQty == "" ? "0" : tbQty,
		"Category": tbCategory,
		"Class": tbClass,
		"Series": tbSeries,
		"Remark": tbRemark,
		"DefaultStorageKID": defaultStorageKID,
		"BaseUnit": baseUnit,
		"BasePrice": basePrice,
		"BaseRetailPrice": baseRetailPrice,
		"SecondUnit": secondUnit,
		"SecondPrice": secondPrice,
		"SecondRetailPrice": secondRetailPrice,
		"UnitRatio1": unitRatio1,
		"ThirdUnit": thirdUnit,
		"ThirdPrice": thirdPrice,
		"ThirdRetailPrice": thirdRetailPrice,
		"UnitRatio2": unitRatio2,
		"pdaMultUnit": pdaMultUnit,
		"IsOpenMultiCode": isOpenMultiCode,
		"pdaStorage": pdaStorage,
		"tbImage" : tbImage,
		"tbImageFiles" : tbImageFiles
	};
	if (tbCostPrice < 0) {
//		showAlert("成本价不能小于零！");
		$.messager.popup("成本价不能小于零！");
		return;
	}
	
	if (tbOldQty != tbQty) {
		isModestock = true;
	} else {
		isModestock = false;
	}
	
	if (tbDescription) {
		if(enabled2DTable){			
			if($("th[name='total']").html()==""){
				$.messager.popup("系统检测到你输入含有特殊字符,请检查后再次提交");
				return false;
			}
			var tabel= $("#DimensionTable");
			var hasone= tabel.find("tr[name='head']").find("td").length;
			var hassec= tabel.find("tr[name='content']").length;
			if(hasone>=3&&hassec>0){
				submitGoods(dataGoods, "saveGoods", "1");
//				submitDimensionGoods(HandleDimensionData(),tbKID,"saveDimensionGoods");		
				$("#indexGoods").html("");
				$('#copyGoodsLabel').text("复制新增");
				$("#upGoods").removeAttr("disabled");
				$("#nextGoods").removeAttr("disabled");
				iscopy = true;				
			}else{
				$.messager.popup("请完善二维信息！");
				return false;
			}
		}else{
			
			submitGoods(dataGoods, "saveGoods");
			$("#indexGoods").html("");
			$('#copyGoodsLabel').text("复制新增");
			$("#upGoods").removeAttr("disabled");
			$("#nextGoods").removeAttr("disabled");
			iscopy = true;
		}
		if(val!="0" && val!=0){
			
			$('#baseGoodsModal').modal("hide");
		}
		notUpGoods = "";
	} else {
//		showAlert("描述不能为空！");
		$.messager.popup("描述不能为空！");
		notUpGoods = "1";
	}
}

/**
 * 提交数据
 * 
 * @param data
 * @param method
 * @param saveDimension 是否需要保存二维库存
 */
function submitGoods(data,method, saveDimension){
	showProcessModal("正在提交数据...");
	if (isSaveAuto){
		ajaxUploadImg();
	}
	var aa = JSON.stringify(data);
	$.ajax({
		url: "../../GoodsServlet?Enable_2D_Table="+pda2DTable+"&isModestock="+isModestock+"&method=" + method,
		type: "post",
		processData: false,
		contentType: 'application/json',
		data: aa,
		dataType: "text",
		async: true, // false 为同步 （防止多次调GoodsServlet而报connection holder is null，如一边提交一边获取图片信息);
		success : function(data, textStatus) {
//			$("#baseGoodsModal").modal("hide");
			$("#importModal").modal("hide");
			$('#exportModal').modal("hide");
			$('#clearGoodsModal').modal("hide");
			$("#updateStockModal").modal("hide");			

			ajaxUploadImg();
			
			// 提交完后没有后续提交时关闭 [处理中]对话框
			if (!saveDimension || saveDimension != "1") {
				hideProcessModal();
				$.messager.popup("提交成功");
				doSearch();
			} else {
				// 保存二维库存
				submitDimensionGoods(HandleDimensionData(),tbKID,"saveDimensionGoods");
			}
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			hideProcessModal();
//			showAlert("网络异常", "type-warning");
			$.messager.popup("网络异常");
		}
	});
}

/*
 * 上传图片
 */
function ajaxUploadImg(){
	var tbKID = $('#tbKID').val();
	var tbImage = $('#imagefile').val() ;			
	if (tbImage) {
		//上传追加图片
		var options = {
			url: "../../GoodsServlet?method=uploadImgs&goodsKID=" + tbKID,
			type: "post",
			success : function(data) {
				if (data) {
					$.messager.popup(data);
				}
				$('#imagefile').val("");
				var div = document.getElementById('preview');
				div.innerHTML = previewDiv;
				getImgesList(tbKID);
				doSearch();
			},
			error: function(XMLResponse) {
//				showAlert("上传图片失败！", "type-warning");
				$.messager.popup("上传图片失败！");
			}
		};
		$("#fileImg").ajaxSubmit(options);
	}
}

/**
 * 提交二维货品库存
 * @param data
 * @param method
 */
function submitDimensionGoods(data,goodskid,method) {
	setProcessModalMessage("正在处理二维库存……");
	var aa = JSON.stringify(data);
	$.ajax({
		url: "../../GoodsDimensionServlet?Goodskid="+goodskid+"&isModestock="+isModestock+"&method=" + method,
		type: "post",
		processData: false,
		contentType: 'application/json',
		data: aa,
		dataType: "text",
		async: true, // false 为同步 （防止多次调GoodsServlet而报connection holder is null，如一边提交一边获取图片信息）
		success : function(data, textStatus) {
			hideProcessModal();
			$.messager.popup("提交成功");
			doSearch();
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			hideProcessModal();
			showAlert("网络异常", "type-warning");
		}
	});
}
/**
 * 导出货品窗口
 */
function openExport(){
	var permit = timeLimiter();
	if ( permit ){
		var kid = getSelectRows();
		if(kid.length>0){//当前选择了行
			$('#exportContent').html("确定导出<span style='color:red'>" + kid.length + "</span>个货品？<td>	<input type='checkbox' id='cb_img' name='cb_img'><span>导出图片</span>	</td></tr>");
		}else{
			var content='<tr><td><input type="radio" value="-1" checked="checked" name="cb_goods"><span>全部货品</span></td></tr>\
				<tr><td><input type="radio" value="1" name="cb_goods"><span>按条件筛选</span></td></tr>	\
				<td>	<input type="checkbox" id="cb_img" name="cb_img"><span>导出图片</span>	</td></tr>'
			$('#exportContent').html(content);
		}	
		$("#exportModal").modal();
	}else{
		$.messager.popup("导出功能暂时只能在10:00之前和17:30之后操作");
	}
	
}

/**
 * 导出货品
 */
function exportGoods() {
	var isAll = $('#cb_goods').is(':checked');
	var kid = isAll ? -1 : getSelectRows();
	
	var isCheck = $('#cb_img').is(':checked');
	var isExportIMG = 0; // 是否导出图片 1：导出 0：不导出

	if (isCheck) {
		isExportIMG = 1;
	} else {
		isExportIMG = 0;
	}
	
	if (kid.length > 0 || kid == -1) {
		// 关闭导出对话框
		$("#exportModal").modal("hide");
		showProcessModal("正在导出数据...");
		var form = $("<form>");
		form.attr('style', 'display:none');
		form.attr('target', '');
		form.attr('method', 'post');
		form.attr('action', "../../GoodsServlet?method=exportGoods&isExportIMG=" + isExportIMG + "&kid=" + JSON.stringify(kid));

		$('body').append(form);
		form.submit();
		form.remove();
		
	    var options = $("#bootstrapTable").bootstrapTable("getOptions");
		var total = options.totalRows;
		var closeTime = 3;
		if (total > 2000) { //如果总记录数超过2000则10秒钟后自动关闭进度条
			closeTime = 10;
		}
		
		setTimeout(function () { hideProcessModal(); }, closeTime * 1000); // 定时关闭  
	} else {
//		showAlert("没有货品数据可导出！");
		$.messager.popup("没有货品数据可导出！");
	}
}

/**
 * 导入货品窗口
 */
function openImport() {
	$("#importModal").modal();
}

/**
 * 导入货品
 */
function uploadGoods(obj) {
	/*
	var isCheck = $('#cb_check').is(':checked');
	var checkimport = 0;// 是否检查导入
	if (isCheck) {
		checkimport = 1;
	} else {
		checkimport = 0;
	}
	*/
	var ex= exportLimiter(obj);
	if (ex) {
	var checkimport = 1; // Servlet 默认为 1 这里加不加都一样
	var file = $('#goodsfile').val();
	if (file.indexOf(".xls") > 0) {
		$("#importModal").modal("hide");
		showProcessModal("正在导入数据...");
		var options = {
			type: "post",
			url: "../../GoodsServlet?method=importGoods&checkimport=" + checkimport,
			success : function(data) {
				$('#goodsfile').val("");
				hideProcessModal();
				doSearch();

				if (data.substring(0,4)=="导入成功") {
					$.messager.popup(data);
				} else {
					showAlertNew(data,550,"导入失败");
				}
				
			},
			error: function(XMLResponse) {
				$('#goodsfile').val("");
				hideProcessModal();
//				showAlert("导入失败！", "type-warning");
				$.messager.popup("导入失败！");
			}
		};
		
		$("#fileUp").ajaxSubmit(options);  
	} else {
		$('#goodsfile').val("");
//		showAlert("请选择后缀为.xls的Excel文件！");
		$.messager.popup("请选择后缀为.xls的Excel文件！");
	}
	}
}

/**
 * 删除货品
 */
function deletedGoods() {
	var kid = getSelectRows();
	var message = "";
	if (kid.length > 1) {
		message = "确定删除选中的<span style='color:red'>" + kid.length + "</span>个货品？";
	} else {
		message = "确定删除当前选中的货品吗？";
	}

	showConfirm(message, function() {
		isModestock=true;
		submitGoods(kid, "deletedGoods");
	}, "type-danger");
}

/**
 * 下载模版
 */
function downloadTemp() {
	$("#btnDownloadTemp").button("loading"); 
	setTimeout(function () { $("#btnDownloadTemp").button("reset"); }, 1000);
	
	var form = $("<form>");
	form.attr('style', 'display:none');
	form.attr('target', '');
	form.attr('method', 'post');
	form.attr('action', "../../GoodsServlet?method=downloadTemp");

	$('body').append(form);
	form.submit();
	form.remove();
}

/**
 * 清空货品窗口
 */
function openClearGoods(){
	$('#clearGoodsModal').modal();
}

/**
 * 清空数据
 */
function clearData(){
	var pwd = $.trim($('#clearpwd').val());
	if (pwd == "84106666") {
		var options = $("#bootstrapTable").bootstrapTable("getOptions");
		var total = options.totalRows;
		if (total.length > 0){
			showConfirm("确定要清空所有货品数据吗？", function () {
				$('#clearpwd').val("");
				$('#clearGoodsModal').modal("hide");
				submitGoods("", "deletedAllGoods");
			}, "type-danger");
		} else {
//			showAlert("没有货品数据可清空.");
			$.messager.popup("没有货品数据可清空。");
		}
	} else {
//		showAlert("密码错误，请重新输入.");
		$.messager.popup("密码错误，请重新输入。");
	}

}

/**
 * 打开修改库存窗口
 */
function openUpdateStock() {
	var kid = getSelectRows();
	$("[name = 'cb_allGoods']:checkbox").attr("checked", false);  
	$('#stocks').text("已选中" + kid.length + "个货品。");
	$("#captcha").val("");
	$("#updateStockModal").modal();
}

/**
 * 修改库存
 */
function updateStock() {
	var qty = $('#txtStock').val();
	var captcha = $.trim($("#captcha").val()); // 用户输入的验证码
	var responseCaptcha = $.trim($("#responseCaptcha").val()); // Servlet响应后得到的手机验证码
	
	if (qty) {
		var isCheck = $('#cb_allGoods').is(':checked'); // 是否修改全部货品库存
		if (isCheck) {
			if (responseCaptcha == "") {
				$.messager.popup("请点击获取验证码！");
				return;
			}
			
			if (captcha != responseCaptcha) {
				$.messager.popup("验证码输入有误，请重新输入！");
				return;
			}
			
			showConfirm("确定要修改全部货品的库存数吗？"+pda2DTable?"仅修改一维货品库存":"操作前请确认清楚！！"+"", function () {
				isModestock=true;
				submitGoods("", "updateGoodsStock&isAll=1&qty=" + qty);
			});
		} else {
			var params = getSelectRowsStock();
			if (params.length == 0) {
				$.messager.popup("请选择要修改的货品。");
			} else {
				isModestock=true;
				if (responseCaptcha == "") {
					$.messager.popup("请点击获取验证码！");
					return;
				}				
				if (captcha != responseCaptcha) {
					$.messager.popup("验证码输入有误，请重新输入！");
					return;
				}
				submitGoods(params, "updateGoodsStock&isAll=0&qty=" + qty);
			}
		}
	} else {
//		showAlert("库存数不能为空.");
		$.messager.popup("库存数不能为空。");
	}
}

/**
 * 切换图片
 * @param imageKid
 */
function changeImg(index) {
	$('#pd_img').attr("src", "../../downImage?imageKid=" + imageKIDList[index] + "&showRawImage=1");
}

/**
 * 删除图片
 * @param imageKid
 */
function deleteImg(index) {
	showConfirm("确定删除当前图片吗？", function () {
		$.ajax({
			url: "../../GoodsServlet?method=deletedGoodsImg&imageKid=" + imageKIDList[index],
			type: "post",
			success: function(data, textStatus) {
				getImgesList($('#tbKID').val());
				doSearch();
			},
			error: function(XMLHttpRequest, textStatus, errorThrown) {
//				showAlert("删除失败！", "type-warning");
				$.messager.popup("删除失败！");
			}
		});
	});
}

/**
 * 仅能输入数字
 * @param keyCode
 * @returns {Boolean}
 */
function isNumber(keyCode) {
    // 数字
    if (keyCode >= 48 && keyCode <= 57 ) return true
    // 小数字键盘
    if (keyCode >= 96 && keyCode <= 105) return true
    if (keyCode >= 109 && keyCode <= 110) return true
    if (keyCode >= 189 && keyCode <= 190) return true
    // Backspace键
    if (keyCode == 8) return true
    return 0
}


/**
 * 获取短信验证码
 */
function getCaptcha(){
	// ---------- 发送按钮禁用60秒 「Begin」 ----------
	var count = 60;
	var progressTimer = "";
	var captchaCaption = $("#btnCaptcha").html();
	
	$("#btnCaptcha").attr("disabled", "disabled");
	progressTimer = setInterval(function() {
		if (count <= 0) {
			clearInterval(progressTimer);
			$("#btnCaptcha").html(captchaCaption);
			$("#btnCaptcha").removeAttr("disabled", "disabled");
			return;
		}
		
		count--;
		$("#btnCaptcha").html(captchaCaption + "(" + count + ")");
	}, 1000);
	// ---------- 发送按钮禁用60秒 「End」 ----------
	
	var phone = $('#bossPhone').val();
	showProcessModal("正在向" + phone + "发送短信验证码...");
    $.ajax({
    	url: "../../SMSManager?method=sendRandCode&phone=" + phone, //发送请求地址
    	type: "post",
    	dataType: "json",
    	success:function(data,textStatus){
    		hideProcessModal();
 		    var error = data.error;
 		    var resultCode = data.resultCode;
		    
		    // 禁用发送按钮，-2：发送次数过多 -3：余额不足
		    if (resultCode == -2 || resultCode == -3) {
		    	clearInterval(progressTimer);
		    	$("#btnCaptcha").attr("disabled", "disabled");
		    	$("#btnCaptcha").html(captchaCaption);
		    }
		    
 		    if (error) {
// 		    	showAlert(error, "type-warning");
 		    	$.messager.popup(error);
 		    	return;
 		    }
 		    
			var randcode = data.randcode;
			var success = data.success;
			
 		    $('#responseCaptcha').val(randcode);
// 		    showAlert(success, "type-success");
 		   $.messager.popup(success);
    	},
    	error:function(XMLHttpRequest, textStatus, errorThrown){
    		hideProcessModal();
//    		showAlert("网络异常", "type-warning");
    		$.messager.popup("网络异常");
 	   }
    });
}

/**
 * 按钮倒计时
 * @param btnIdName
 * @param btnCaption
 */
function btnCountDown(interval, btnIdName, btnCaption) {
	var count = interval;
	var progressTimer = "";
	$("#" + btnIdName).attr("disabled", "disabled");
	
	$("#" + btnIdName).html(btnCaption + "(" + count + ")");
	progressTimer = setInterval(function() {
		if (count <= 0) {
			$("#" + btnIdName).html(btnCaption);
			$("#" + btnIdName).removeAttr("disabled");
			clearInterval(progressTimer);
			return;
		}
		
		count--;
		$("#" + btnIdName).html(btnCaption + "(" + count + ")");
	}, 1000);
}

/**
 * 导出货品(新方法)
 * 如果当前页数据全部选中，则通过pageSize和pageNumber去查询数据导出
 * 如果当前页数据没有全部选中，则通过选中的数据行号（rowNumber）去查询数据导出
 * liaofg
 * 2016-03-21 17:52
 */
function toExportGoods(obj) {
	var ex= exportLimiter(obj);
	if (ex) {
	var isCondition = $('input:radio[name=cb_goods]:checked').val();
	var rowNumber = isCondition==undefined ? getSelectRowNumbers() : isCondition;
	var rowKids = isCondition==undefined ? getSelectRows() : isCondition;
	var isCheck = $('#cb_img').is(':checked');
	var isExportIMG = 0; // 是否导出图片 1：导出 0：不导出

	if (isCheck) {
		isExportIMG = 1;
	} else {
		isExportIMG = 0;
	}
	if (rowNumber.length > 0 || rowNumber==-1 || rowNumber==1) {
		// 关闭导出对话框
		$("#exportModal").modal("hide");
		showProcessModal("正在导出数据,导出过程切勿刷新...");
		var form = $("<form>");
		form.attr('style', 'display:none');
		form.attr('target', '');
		form.attr('method', 'post');
		var strQty="&Qty_Scale="+$('#Qty_Scale').val()+"&rowKids="+rowKids;
		$("#searchText").val() ? searchVal = $("#searchText").val() : searchVal = '';
		if(checkAllCurrentRows){//全选
			if(rowNumber==-1){//导出全部
				form.attr('action', "../../GoodsServlet?method=exportGoodsByRowNumber&isExportIMG=" + isExportIMG + "&searchValue="+searchVal+"&checkAllCurrentRows=true&rowNumber="+JSON.stringify(rowNumber)+"&"+exportQueryParams()+strQty);
			}else{
				form.attr('action', "../../GoodsServlet?method=exportGoodsByRowNumber&isExportIMG=" + isExportIMG + "&searchValue="+searchVal+"&checkAllCurrentRows=true&"+exportQueryParams()+strQty);
			}
		}else{//非全选
			var editTag = document.getElementById('editTagGoods'); 
			var editStorage = document.getElementById('editStorage'); 
			var tagName = editTag.options[editTag.selectedIndex].value;
			if (tagName=="selectTagGoods") {
				tagName="";
			}
			var storageKID="";
			if (pdaStorage == "1" || pdaStorage == 1) {
				storageKID = editStorage.options[editStorage.selectedIndex].value;
				if (storageKID=="selectStorage") {
					storageKID="";
				}
			}
			
			if(isCondition==undefined){
				form.attr('action', "../../GoodsServlet?method=exportGoodsByRowNumber&isExportIMG=" + isExportIMG + "&searchValue="+searchVal+"&checkAllCurrentRows=false&rowNumber=" + JSON.stringify(rowNumber)+"&"+exportQueryParams()+strQty+"&storageKID="+
					    storageKID+"&tagName="+tagName);
			}else{
				form.attr('action', "../../GoodsServlet?method=exportGoodsByRowNumber&isExportIMG=" + isExportIMG + "&searchValue="+searchVal+"&checkAllCurrentRows=false&isCondition="+isCondition+"&rowNumber=" + JSON.stringify(rowNumber)+"&"+exportQueryParams()+strQty+"&storageKID="+
					    storageKID+"&tagName="+tagName);
			}
		}
		
		$('body').append(form);
		form.submit();
		form.remove();
		
//	    导出框时间控制
		clock_check=window.setInterval(checkIsExporting, 1000);
		 
	} else {
//		showAlert("没有货品数据可导出！");
		$.messager.popup("没有货品数据可导出！");
	}
	}
}
function checkIsExporting() {
	$.post(basePath+"/GoodsServlet?method=getIsImporting", null,function(data){
		if (data!=null && data=="false") {
			window.clearInterval(clock_check);  
			hideProcessModal();
		}
	});
}

/**
 * 获取已选择序号
 * @returns {Array}
 */
function getSelectRowNumbers(){
	var RowNumber = [];
	var rows = $('#bootstrapTable').bootstrapTable('getSelections'); // 取得所有选择的行
	if (rows.length > 0) {
		for (var i = 0; i < rows.length; i++) {
			RowNumber.push(rows[i].RowNumber);
		}
	}
	return RowNumber;
}
/**
 * 显示按钮
 */
function showByCondition(){
	if($("input[name='cb']").length>0){
		$("input:radio[name='cb_goods']").attr("checked",false);	
	}
}
/**
 * 隐藏按钮
 */
function hideByCondition(){
	if($("input[name='cb_goods']").length>0){
		$("input:radio[name='cb_goods']").attr("checked",false);	
	}
}

function hideOrShowCondition(){
	var rows = $('#bootstrapTable').bootstrapTable('getSelections'); // 取得所有选择的行
	if(rows.length>0){
		//当前有行选中，则隐藏
		hideByCondition();
	}else{
		//当前没有行选中，则显示
		showByCondition();
	}

}

/**
 * 数据导出参数设置
 * @param params
 * @returns
 */
function exportQueryParams() {
	startDate = startDate==undefined?"":startDate;
	endDate = endDate==undefined?"":endDate;
	searchText = searchText==undefined?"":searchText;
	sortName = sortName==undefined?"":sortName;
	
	
	return "startDate="+startDate+"&endDate="+endDate+"&isAdvancedSearch="+myIsAdvancedSearch+"&searchText="+searchText+
    "&pageNumber="+pageNumber+"&pageSize="+pageSize+"&sortName="+sortName+"&sortOrder="+sortOrder;
}
function formatRemark(value, row, index){
	if(value==null){
		return "";
	}else{
		return "<span title='"+value+"' style='overflow: hidden; text-overflow:ellipsis;white-space:nowrap;display: block;width: 150px;'>"+value+"</span>";
	}
}
function loadSysSetting(enterprisekid){
	$.ajax({
		url: "../../UserServlet?method=getSysSettings&enterpriseKID=" + enterprisekid,
		type: "post",
		dataType : "json",
		async: false,
		success: function(data, textStatus) {
			hideProcessModal();
			var error = data.error;
			if (error) {
				$.messager.popup(error);
				return;
			}
			if (data.SysSettings.length > 0) {
				// 解析数组
				$.each(data.SysSettings, function(i, item) {
					if (item.ItemName == "PDA_Storage") {
						$("#PDA_Storage").val(item.Value);
					}else if(item.ItemName == "isOpenStorage"){
						$("#SERVER_Storage").val(item.Value);
					}
				});
			}
			if("1" == $("#SERVER_Storage").val() || 1 == $("#SERVER_Storage").val()){
				if(data.Storage.length > 0){
					$("#defaultStorageKID").val(data.Storage[0].KID);
				}
			}
			
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			hideProcessModal();
			$.messager.popup("网络异常");
		}
	});
}
/**
 * 弹窗自适应展示
 */
function selfAdaption(){
	setTimeout(function(){
		//货品维护的弹窗自适应
		var dialog = $(".modal-dialog").height();
		var dialogCon = $(".modal-content").height();
		var dialogHeader = $(".modal-header").height();
//		console.log('外：'+dialog,'内：'+dialogCon);
		if ( dialog < dialogCon ){
			$(".modal").css({"position": "absolute"});
			$(".modal-dialog").css({"overflow":"auto"});
			var dialogBody = dialog - dialogHeader - 80;
			$("#myTabContent").height( dialogBody );
			$("#myTabContent").niceScroll({  
				cursorcolor:"#d4d4d4",  
				cursoropacitymax:1,  
				touchbehavior:false,  
				cursorwidth:"5px",  
				cursorborder:"0",  
				cursorborderradius:"5px"  
			}); 
//			$("#myTabContent").getNiceScroll().hide();
		}				
	},300);
}


/**
 * setUnit
 * 当基本单位修改时同时修改比例的基本单位
 * @param {type} param 
 */
 function setUnit() {
 	$(".base_unit01").html($("#baseUnit").val());
 	$(".second_unit01").html($("#secondUnit").val());
 }
 
 /**
  * addAndRemoveUnitReadOnly
  * 处理比例的控制,当编辑的时候新增其他比例是允许的，不需要限制
  * @param {type} param 
  */
  function addAndRemoveUnitReadOnly() {
//  	如果单位，二级单位不为空 且 比例不为空且不为0，就给对应的比例添加readnonly属性;
	if ($("#secondUnit").val()!="" && $("#unitRatio1").val()!=""  && $("#unitRatio1").val()!=0) {
		$("#unitRatio1").attr("readonly","readonly");
	} else {
		$("#unitRatio1").removeAttr("readonly");
	}
	if ($("#thirdUnit").val()!="" && $("#unitRatio2").val()!=""  && $("#unitRatio2").val()!=0) {
		$("#unitRatio1").attr("readonly","readonly");
		$("#unitRatio2").attr("readonly","readonly");
	} else {
		$("#unitRatio2").removeAttr("readonly");
	}
	
  }
   /**
   * 加载商品缓存
   */
   function getGoodsBuffer() {
   	$.ajax({
		  type: "post",
		  data:{"method":"getBufferGoods"},
		  url: '../../GoodsServlet?',
		  success: function(data){		
//		  	alert("加载缓存OK!");			  
		  },
		  error: function(xhr, type){
//		  	alert("加载缓存失败");
		  }
	});
   }
   
  